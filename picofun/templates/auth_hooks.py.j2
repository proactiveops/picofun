"""Auto-generated authentication hooks for PicoFun.

This module is automatically generated based on the OpenAPI security scheme.
Do not edit this file manually - it will be regenerated on each build.
"""

import os
{% if scheme_type == 'http' and scheme_scheme == 'basic' %}
import base64
{% elif scheme_type == 'mutualTLS' %}
{% endif %}

from aws_lambda_powertools.utilities import parameters


def get_credentials(scheme_name: str) -> dict:
    """
    Retrieve credentials from AWS SSM Parameter Store.

    Args:
        scheme_name: The name of the security scheme

    Returns:
        Dictionary containing the credentials

    """
    ttl = int(os.environ.get("PICORUN_CREDENTIALS_TTL", "300"))
    param_path = f"/picofun/{{ namespace }}/credentials-{scheme_name}"

    return parameters.get_parameter(param_path, decrypt=True, transform="json", max_age=ttl)


def preprocessor(request):
    """
    Apply authentication to the request.

    This preprocessor is automatically generated based on the OpenAPI
    security scheme: {{ scheme_name }} ({{ scheme_type }})

    Args:
        request: The picorun ApiRequestArgs object

    Returns:
        The modified request object with authentication applied

    """
{% if scheme_type == 'apiKey' %}
    creds = get_credentials("{{ scheme_type_kebab }}")
    {% if scheme_location == 'header' %}
    request.headers["{{ scheme_param_name }}"] = creds["api_key"]
    {% elif scheme_location == 'query' %}
    request.params["{{ scheme_param_name }}"] = creds["api_key"]
    {% elif scheme_location == 'cookie' %}
    request.cookies["{{ scheme_param_name }}"] = creds["api_key"]
    {% endif %}
{% elif scheme_type == 'http' and scheme_scheme == 'basic' %}
    creds = get_credentials("{{ scheme_type_kebab }}")
    credentials = base64.b64encode(
        f"{creds['username']}:{creds['password']}".encode()
    ).decode()
    request.headers["Authorization"] = f"Basic {credentials}"
{% elif scheme_type == 'http' and scheme_scheme == 'bearer' %}
    creds = get_credentials("{{ scheme_type_kebab }}")
    request.headers["Authorization"] = f"Bearer {creds['token']}"
{% elif scheme_type == 'mutualTLS' %}
    creds = get_credentials("{{ scheme_type_kebab }}")
    # Write certs to fixed locations for requests library
    # Files are overwritten on each request since Powertools caching doesn't expose expiry
    with open('/tmp/picorun_cert.pem', 'w') as f:
        f.write(creds["cert"])
    with open('/tmp/picorun_key.pem', 'w') as f:
        f.write(creds["key"])
    request.cert = ('/tmp/picorun_cert.pem', '/tmp/picorun_key.pem')
{% endif %}
    return request
